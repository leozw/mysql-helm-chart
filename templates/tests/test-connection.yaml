apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "tpl.fullname" . }}-test-connection"
  labels:
    {{- include "tpl.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: mysql-test
      image: mysql:8.0.40
      env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.secretName | default (printf "%s-secret" .Release.Name) | quote }}
              key: MYSQL_ROOT_PASSWORD
      command:
        - sh
        - -c
        - |
          mysql -h {{ .Release.Name }}-service -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT VERSION();"
  restartPolicy: Never